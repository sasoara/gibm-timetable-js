<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <title>Stundenplan</title>
</head>

<body class="container-fluid">
    <h1>Stundenplan GIBM</h1>
    <p class="lead">Gründenstrasse 46,
        4132 Muttenz
    </p>

    <div class="container mt-5">
        <div id="message" class="alert alert-warning" hidden></div>
        <form action="" method="GET">
            <h3>Berufsgruppe</h3>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="berufsgruppenAuswahl">Optionen</label>
                </div>
                <select class="custom-select berufsgruppe" id="berufsgruppenAuswahl">
                    <option selected>Wählen Sie einen Beruf aus</option>
                </select>
            </div>
            <h3>Klassenauswahl</h3>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <label class="input-group-text" for="klassenAuswahl">Optionen</label>
                </div>
                <select class="custom-select klassenauswahl" id="klassenAuswahl">
                </select>
            </div>
        </form>


        <div id="anzeige" class="pt-5 d-table mx-auto">
            <button id="previous" type="button" class="btn btn-outline-dark btn-sm">&lt; vorherige Woche</button>
            <label class="px-5">Woche <span id="week"></span></label>
            <button id="next" type="button" class="btn btn-outline-dark btn-sm">nächste Woche &gt;</button>
        </div>


        <!-- <div class="mt-5 spinner-grow d-table mx-auto" role="status">
            <span class="sr-only">Loading...</span>
        </div> -->


        <div class="table-responsive mt-5">
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Datum</th>
                        <th scope="col">Wochentag</th>
                        <th scope="col">Von</th>
                        <th scope="col">Bis</th>
                        <th scope="col">Lehrer</th>
                        <th scope="col">Fach</th>
                        <th scope="col">Raum</th>
                    </tr>
                </thead>
                <tbody id="time-table">
                </tbody>
            </table>
        </div>
    </div>
</body>
<script>
    // holt bzw. returned die Daten der Schulwebseite
    function getBerufe() {
        return $.getJSON(`http://sandbox.gibm.ch/berufe.php`)

            .done(function (jobs) {
                return jobs;
            })

            .fail(function () {
                return $('div.alert').removeAttr('hidden').text("Leere Liste wegen Netzwerkfehler. Überprüfe den Link.");
            });
    }

    function getKlassen(beruf_id = 0) {
        return $.getJSON(`http://sandbox.gibm.ch/klassen.php?beruf_id=${beruf_id}`)

            .done(function (schoolClasses) {
                return schoolClasses;
            })

            .fail(function () {
                return $('div.alert').removeAttr('hidden').text("Leere Liste wegen Netzwerkfehler. Überprüfe den Link.");
            });
    }

    function getCurrentWeekNumber_Year() {
        const today = new Date();
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        return `${weekNumber}-${today.getFullYear()}`;
    }

    function previousWeek_Year(current) {
        const splitCurrent = current.split('-');
        return `${splitCurrent[0] - 1}-${splitCurrent[1]}`;
    }

    function nextWeek_Year(current) {
        const splitCurrent = current.split('-');
        return `${1 + parseInt(splitCurrent[0])}-${splitCurrent[1]}`;
    }

    function getTafel(klasse_id = 0, woche) {
        const url = woche ? `http://sandbox.gibm.ch/tafel.php?klasse_id=${klasse_id}&woche=${woche}` :
            `http://sandbox.gibm.ch/tafel.php?klasse_id=${klasse_id}`;
        return $.getJSON(url)

            .done(function (timeTable) {
                return timeTable;
            })

            .fail(function () {
                return $('div.alert').removeAttr('hidden').text("Leere Liste wegen Netzwerkfehler. Überprüfe den Link.");
            });
    }

    function prepareOptionGroupsForBerufsgruppe(jobs) {
        const firstLetters = $.unique(jobs.map((job) => job.beruf_name[0]));
        return firstLetters.map((letter) => `<optgroup label=${letter}></optgroup>`);
    }

    function prepareOptionsBerufe(jobs) {
        const selectOptions = jobs.map((job) => {
            const objOptions = {
                name: job.beruf_name,
                tag: `<option value=${job.beruf_id}>${job.beruf_name}</option>`
            }
            return objOptions;
        });
        return selectOptions;
    }

    function prepareOptionsKlassen(klassen) {
        const selectOptions = klassen.map((klasse) => {
            const objOptions = `<option value=${klasse.klasse_id}>${klasse.klasse_name}</option>`
            return objOptions;
        });
        return selectOptions;
    }

    function handleSelectedJob() {
        const job = $('#berufsgruppenAuswahl >> option:selected');
        getKlassen(job.val()).then((klassen) => {
            const options = prepareOptionsKlassen(klassen);
            $('#klassenAuswahl').html('<option selected>Bitte Klasse wählen</option>');
            options.forEach((option) => {
                $('#klassenAuswahl').append(option);
            });
        });
    }

    function formatDate(dateString) {
        const splitDate = dateString.split('-');
        return `${splitDate[2]}.${splitDate[1]}.${splitDate[0]}`;
    }

    function formatWeekday(dayAsNumber) {
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        return days[dayAsNumber];
    }

    function handleSelectedClass() {
        const selectedClass = $('#klassenAuswahl > option:selected');
        $('#week').text(getCurrentWeekNumber_Year());
        getTafel(selectedClass.val()).then((tafeln) => {
            const table = $('#time-table');
            table.html('');
            const tableContent = getTableContent(tafeln);
            table.append(tableContent);
        });
    }

    function getTableContent(tafeln) {
        return tafeln.map((tafel) => {
            const table_th = `<th scope='row'>${formatDate(tafel.tafel_datum)}</th>`;
            const table_td = {
                wochentag: `<td>${formatWeekday(tafel.tafel_wochentag)}</td>`,
                von: `<td>${tafel.tafel_von}</td>`,
                bis: `<td>${tafel.tafel_bis}</td>`,
                lehrer: `<td>${tafel.tafel_lehrer}</td>`,
                fach: `<td>${tafel.tafel_fach}</td>`,
                raum: `<td>${tafel.tafel_raum}</td>`
            }
            return `<tr>${table_th}${table_td.wochentag + table_td.von + table_td.bis + table_td.lehrer + table_td.fach + table_td.raum}</tr>`;
        });
    }

    function handlePreviousWeekButton() {
        const selectedClass = $('#klassenAuswahl > option:selected');
        const previousWeek = previousWeek_Year($('#week').text());
        $('#week').text(previousWeek);
        getTafel(selectedClass.val(), previousWeek).then((tafeln) => {
            const table = $('#time-table');
            table.html('');
            const tableContent = getTableContent(tafeln);
            table.append(tableContent);
        });
        return;
    }

    function handleNextWeekButton() {
        // TODO: the handling if previous or next button is clicked.
        const prev = $('#previous');
        const next = $('#next');
        console.log('vor');
        return;
    }

    // jQuery check, ob der DOM geladen ist.
    $(function () {

        getBerufe().then((jobs) => {
            const optionGroups = prepareOptionGroupsForBerufsgruppe(jobs);
            $('select.berufsgruppe').append(optionGroups);

            const options = prepareOptionsBerufe(jobs);
            options.forEach((option) => {
                const optionGroup = $(`optgroup[label = ${option.name[0]}]`);
                optionGroup.append(option.tag);
            });
        });

        $('#berufsgruppenAuswahl').on('change', handleSelectedJob);
        $('#klassenAuswahl').on('change', handleSelectedClass);
        $('#previous').on('click', handlePreviousWeekButton);
        $('#next').on('click', handleNextWeekButton);
    });
</script>


</html>